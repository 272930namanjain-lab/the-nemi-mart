<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nemi Mart | Master Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #1a2332; --orange: #e68a00; --green: #2e7d32; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f6; display: flex; flex-direction: column; }
        
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--blue); z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .auth-card { background: white; padding: 40px; border-radius: 15px; text-align: center; color: var(--blue); width: 90%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .pass-container { position: relative; margin: 20px 0; }
        .pass-container input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; padding-right: 40px; }
        .pass-container i { position: absolute; right: 10px; top: 12px; cursor: pointer; color: #888; }
        
        header { background: var(--blue); color: white; padding: 15px; text-align: center; }
        .stats-container { display: flex; justify-content: center; gap: 20px; padding: 20px; background: #fff; border-bottom: 1px solid #eee; }
        .stat-box { background: #fff; border: 1px solid #ddd; padding: 15px 30px; border-radius: 10px; text-align: center; min-width: 150px; }
        .stat-box h2 { margin: 5px 0; color: var(--orange); }
        .stat-box p { margin: 0; font-size: 12px; font-weight: bold; color: #666; }

        .nav-tabs { display: flex; justify-content: center; gap: 10px; padding: 15px; background: #fff; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #eee; }
        .active-tab { background: var(--orange); color: white; }
        
        .container { padding: 20px; max-width: 1100px; margin: auto; width: 95%; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; font-size: 13px; }
        th { background: #f9f9f9; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin: 5px 0; width: 100%; box-sizing: border-box; font-family: inherit; }
        .btn-delete { color: red; background: none; border: none; cursor: pointer; font-weight: bold; }
        .badge-free { background: #e8f5e9; color: var(--green); padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .prod-img-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; background: #eee; }
        
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <i class="fas fa-shield-alt" style="font-size: 40px; color: var(--orange);"></i>
        <h3>Admin Access</h3>
        <p style="font-size: 12px; color: #666;">Hint: The supreme path of non-violence</p>
        <div class="pass-container">
            <input type="password" id="admin_pass" placeholder="Enter Access Code">
            <i class="fas fa-eye" id="togglePass" onclick="toggleVisibility()"></i>
        </div>
        <button class="tab-btn active-tab" style="width: 100%;" onclick="checkAuth()">Verify Identity</button>
    </div>
</div>

<header>
    <h1>The Nemi Mart Admin</h1>
    <p style="font-size: 12px;">Manage Orders, Inventory & Pricing</p>
</header>

<div class="stats-container">
    <div class="stat-box"><p>TOTAL SALES</p><h2 id="total-revenue">₹0</h2></div>
    <div class="stat-box"><p>TOTAL ORDERS</p><h2 id="total-orders">0</h2></div>
</div>

<div class="nav-tabs">
    <button class="tab-btn active-tab" onclick="openTab('orders')">Orders & Logistics</button>
    <button class="tab-btn" onclick="openTab('products')">Inventory & Pricing</button>
</div>

<div class="container">
    <div id="orders-sec">
        <div class="card">
            <h3>Manage Orders (UTR Verification)</h3>
            <table>
                <thead>
                    <tr>
                        <th>User Details</th>
                        <th>UTR Number</th>
                        <th>Status</th>
                        <th>Logistics & Tracking</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="order-rows"></tbody>
            </table>
        </div>
    </div>

    <div id="products-sec" style="display:none;">
        <div class="card">
            <h3>Add New Product</h3>
            <div class="grid-3">
                <input type="text" id="p_name" placeholder="Product Name">
                <input type="number" id="p_original" placeholder="MRP (Original Price)">
                <input type="number" id="p_price" placeholder="Sale Price (Discounted)">
            </div>
            <div class="grid-3" style="margin-top:10px;">
                <input type="text" id="p_category" placeholder="Category (e.g. Essential Oils)">
                <input type="number" id="p_rating" placeholder="Rating (1-5)" step="0.1" max="5">
                <select id="p_stock">
                    <option value="In Stock">Status: In Stock</option>
                    <option value="Out of Stock">Status: Out of Stock</option>
                </select>
            </div>
            <div class="grid-2" style="margin-top:10px;">
                <input type="text" id="p_img" placeholder="Paste Google Drive Link or Image URL">
                <select id="p_free_shipping">
                    <option value="true">Free Delivery: YES</option>
                    <option value="false">Free Delivery: NO</option>
                </select>
            </div>
            <textarea id="p_desc" placeholder="Product Description (Benefits, How to use, etc.)" rows="4"></textarea>
            
            <button class="tab-btn active-tab" style="margin-top:10px; width:100%" onclick="addNewProduct()">Add to Inventory</button>
        </div>

        <div class="card">
            <h3>Current Inventory</h3>
            <table style="table-layout: fixed;">
                <thead>
                    <tr>
                        <th style="width: 60px;">Img</th>
                        <th>Product Info</th>
                        <th style="width: 80px;">Price</th>
                        <th style="width: 100px;">Stock</th>
                        <th style="width: 80px;">Action</th>
                    </tr>
                </thead>
                <tbody id="inventory-rows"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const _supabase = supabase.createClient("https://rzmftpafcyxburlkwqnm.supabase.co", "sb_publishable_zt4Wt4wBgarEU15zF-RoKw_4achnceD");

    function checkAuth() {
        if (document.getElementById('admin_pass').value === "Ahimsa Paramo Dharam") {
            document.getElementById('auth-overlay').style.display = 'none';
            loadData();
        } else { alert("Unauthorized Access!"); }
    }

    function toggleVisibility() {
        const pInput = document.getElementById('admin_pass');
        const icon = document.getElementById('togglePass');
        pInput.type = pInput.type === "password" ? "text" : "password";
        icon.classList.toggle('fa-eye-slash');
    }

    function fixGDriveLink(link) {
        if (link.includes('drive.google.com')) {
            let id = link.includes('id=') ? link.split('id=')[1].split('&')[0] : link.split('/d/')[1].split('/')[0];
            return `https://lh3.googleusercontent.com/u/0/d/${id}`;
        }
        return link;
    }

    function openTab(tab) {
        document.getElementById('orders-sec').style.display = tab === 'orders' ? 'block' : 'none';
        document.getElementById('products-sec').style.display = tab === 'products' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        if(event) event.target.classList.add('active-tab');
    }

    async function loadData() {
        const { data: orders } = await _supabase.from('orders').select('*').order('created_at', { ascending: false });
        const { data: products } = await _supabase.from('products').select('*').order('created_at', { ascending: false });
        
        if (orders) {
            const revenue = orders.reduce((sum, o) => sum + (Number(o.amount) || 0), 0);
            document.getElementById('total-revenue').innerText = '₹' + revenue;
            document.getElementById('total-orders').innerText = orders.length;

            document.getElementById('order-rows').innerHTML = orders.map(o => `
                <tr>
                    <td><b>${o.user_name || 'N/A'}</b><br><small>${o.user_email}</small></td>
                    <td style="color:blue; font-weight:bold;">${o.utr_number}</td>
                    <td>
                        <select onchange="updateRow('orders', '${o.id}', {status: this.value})">
                            <option ${o.status=='Pending'?'selected':''}>Pending</option>
                            <option ${o.status=='Verified'?'selected':''}>Verified</option>
                            <option ${o.status=='Shipped'?'selected':''}>Shipped</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" placeholder="Courier" value="${o.courier_name || ''}" onblur="updateRow('orders', '${o.id}', {courier_name: this.value})">
                        <input type="text" placeholder="Tracking URL" value="${o.tracking_url || ''}" onblur="updateRow('orders', '${o.id}', {tracking_url: this.value})">
                    </td>
                    <td><button class="btn-delete" onclick="deleteRow('orders', '${o.id}')">Remove</button></td>
                </tr>
            `).join('');
        }

        if (products) {
            document.getElementById('inventory-rows').innerHTML = products.map(p => `
                <tr>
                    <td><img src="${fixGDriveLink(p.image_url)}" class="prod-img-preview" onerror="this.src='https://via.placeholder.com/50'"></td>
                    <td>
                        <div style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p.name}</div>
                        <small style="color:#888;">${p.category || 'No Category'}</small>
                    </td>
                    <td><del style="font-size:10px;">₹${p.original_price}</del><br><span style="color:green;font-weight:bold;">₹${p.price}</span></td>
                    <td>
                        <select style="font-size:11px;" onchange="updateRow('products', '${p.id}', {stock_status: this.value})">
                            <option ${p.stock_status=='In Stock'?'selected':''}>In Stock</option>
                            <option ${p.stock_status=='Out of Stock'?'selected':''}>Out of Stock</option>
                        </select>
                    </td>
                    <td><button class="btn-delete" onclick="deleteRow('products', '${p.id}')">Delete</button></td>
                </tr>
            `).join('');
        }
    }

    async function updateRow(table, id, updateData) {
        await _supabase.from(table).update(updateData).eq('id', id);
    }

    async function deleteRow(table, id) {
        if(confirm("Are you sure?")) {
            await _supabase.from(table).delete().eq('id', id);
            loadData();
        }
    }

    async function addNewProduct() {
        const fields = {
            name: document.getElementById('p_name').value,
            original_price: document.getElementById('p_original').value,
            price: document.getElementById('p_price').value,
            image_url: fixGDriveLink(document.getElementById('p_img').value),
            is_free_shipping: document.getElementById('p_free_shipping').value === "true",
            description: document.getElementById('p_desc').value,
            category: document.getElementById('p_category').value,
            rating: document.getElementById('p_rating').value || 4.5,
            stock_status: document.getElementById('p_stock').value
        };

        if(!fields.name || !fields.price || !fields.image_url) return alert("Please fill Name, Price and Image URL");

        const { error } = await _supabase.from('products').insert([fields]);
        if(error) { alert("Error: " + error.message); } 
        else {
            alert("Product Added!");
            loadData();
            ['p_name','p_original','p_price','p_img','p_desc','p_category','p_rating'].forEach(id => document.getElementById(id).value = '');
        }
    }
</script>
</body>
</html>
