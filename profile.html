<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | The Nemi Mart</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --blue: #1a2332; --orange: #e68a00; --light: #f4f7f6; --green: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); color: var(--blue); }
        
        header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo-box { display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; }
        .logo-img { width: 35px; border-radius: 50%; }

        .container { padding: 30px 5%; max-width: 800px; margin: 0 auto; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-card i { font-size: 1.5rem; color: var(--orange); margin-bottom: 10px; }
        .stat-value { font-size: 1.8rem; font-weight: 800; display: block; }
        .stat-label { font-size: 0.8rem; color: #777; font-weight: 600; text-transform: uppercase; }

        /* Referral Link Box */
        .referral-box { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 2px dashed var(--orange); }
        .referral-box h3 { margin-top: 0; font-size: 1.2rem; }
        .link-display { background: #f0f0f0; padding: 12px; border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 0.9rem; word-break: break-all; display: block; border: 1px solid #ddd; }
        .btn-copy { background: var(--blue); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-copy:hover { background: var(--orange); }

        .logout-btn { margin-top: 40px; color: #e74c3c; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; }
        
        #loading-profile { text-align: center; padding: 50px; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo-box">
        <img src="logo.png" class="logo-img">
        <div class="logo-text"><h1 style="font-size: 1rem; margin:0;">THE NEMI MART</h1></div>
    </a>
    <a href="#" onclick="logout()" class="logout-btn" style="margin:0;"><i class="fas fa-sign-out-alt"></i> Logout</a>
</header>

<div id="loading-profile">
    <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--orange);"></i>
    <p>Loading your rewards...</p>
</div>

<div class="container" id="profile-content" style="display:none;">
    <h2 id="welcome-msg">Hi, User!</h2>
    <p style="color: #666; margin-bottom: 30px;">Manage your rewards and referral links here.</p>

    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-wallet"></i>
            <span class="stat-value" id="wallet-amt">₹0</span>
            <span class="stat-label">Referral Balance</span>
        </div>
        <div class="stat-card">
            <i class="fas fa-truck"></i>
            <span class="stat-value" id="delivery-credits">0</span>
            <span class="stat-label">Free Deliveries</span>
        </div>
    </div>

    <div class="referral-box">
        <h3><i class="fas fa-share-nodes"></i> Your Referral Link</h3>
        <p style="font-size: 0.9rem; color: #555;">Share this link. Friends get ₹5 off, and you get ₹10 + Free Delivery!</p>
        <span class="link-display" id="ref-link-text">Loading link...</span>
        <button class="btn-copy" onclick="copyReferralLink()">
            <i class="fas fa-copy"></i> Copy My Link
        </button>
    </div>
</div>

<script>
    const _supabase = supabase.createClient("https://rzmftpafcyxburlkwqnm.supabase.co", "sb_publishable_zt4Wt4wBgarEU15zF-RoKw_4achnceD");

    async function loadProfile() {
        // 1. Check if user is logged in
        const { data: { user } } = await _supabase.auth.getUser();
        
        if (!user) {
            window.location.href = 'auth.html';
            return;
        }

        // 2. Fetch profile details
        const { data: profile, error } = await _supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if (error) {
            console.error("Error loading profile:", error);
            return;
        }

        // 3. Update UI
        document.getElementById('welcome-msg').innerText = `Hi, ${profile.full_name || 'Friend'}!`;
        document.getElementById('wallet-amt').innerText = `₹${profile.wallet_balance || 0}`;
        document.getElementById('delivery-credits').innerText = profile.free_delivery_credits || 0;
        
        // Generate referral link (Points to index.html with ref code)
        const refLink = `${window.location.origin}/index.html?ref=${profile.referral_code}`;
        document.getElementById('ref-link-text').innerText = refLink;

        // Show content
        document.getElementById('loading-profile').style.display = 'none';
        document.getElementById('profile-content').style.display = 'block';
    }

    function copyReferralLink() {
        const link = document.getElementById('ref-link-text').innerText;
        navigator.clipboard.writeText(link).then(() => {
            alert("Referral link copied! Share it on WhatsApp to earn rewards.");
        });
    }

    async function logout() {
        await _supabase.auth.signOut();
        window.location.href = 'auth.html';
    }

    loadProfile();
</script>
</body>
</html>
