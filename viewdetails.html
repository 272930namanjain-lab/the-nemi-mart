<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | The Nemi Mart</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --blue: #1a2332; --orange: #e68a00; --light: #f4f7f6; --text-gray: #4a4a4a; --green: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #fff; color: var(--text-gray); }
        
        header { background: white; padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; position: sticky; top: 0; z-index: 1000; }
        .logo-box { display: flex; align-items: center; gap: 12px; cursor: pointer; text-decoration: none; }
        .logo-img { width: 40px; height: 40px; border-radius: 50%; }
        .logo-text h1 { margin: 0; font-size: 1rem; color: var(--blue); font-weight: 800; }

        .container { padding: 40px 5%; max-width: 1200px; margin: 0 auto; }
        .detail-wrapper { display: flex; flex-wrap: wrap; gap: 50px; align-items: flex-start; }
        
        .product-image { flex: 1; min-width: 320px; text-align: center; }
        .product-image img { width: 100%; max-width: 500px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #f9f9f9; }
        
        .product-info { flex: 1; min-width: 320px; }
        .category-tag { color: var(--orange); font-weight: bold; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; }
        .price { font-size: 2.5rem; font-weight: 800; color: var(--blue); margin: 15px 0; }
        
        /* Referral Surprise Box */
        #ref-alert { 
            background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 10px; 
            margin-bottom: 20px; border-left: 5px solid #4caf50; display: none;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .desc-container { margin: 25px 0; padding-top: 20px; border-top: 1px solid #eee; }
        .desc-title { font-weight: 800; color: var(--blue); margin-bottom: 10px; display: block; font-size: 1.1rem; }
        .description { line-height: 1.8; color: var(--text-gray); white-space: pre-wrap; font-size: 1rem; }
        
        .btn-group { display: flex; gap: 15px; margin-top: 30px; }
        .buy-now { background: var(--blue); color: white; border: none; padding: 18px 30px; border-radius: 12px; cursor: pointer; font-weight: bold; flex: 1; font-size: 1rem; transition: 0.3s; }
        .buy-now:hover { background: #2c3e50; }

        .share-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .share-title { font-size: 0.9rem; font-weight: bold; color: var(--blue); margin-bottom: 12px; display: block; }
        .share-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
        .share-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; transition: 0.3s; font-size: 1.2rem; border: none; cursor: pointer; }
        
        .wa-share { background: #25D366; }
        .fb-share { background: #1877F2; }
        .tw-share { background: #000000; }
        .ig-share { background: #E4405F; }
        .copy-share { background: #607d8b; }
        
        .share-btn:hover { opacity: 0.8; transform: translateY(-3px); }

        footer { background: var(--blue); color: white; padding: 40px 10%; margin-top: 60px; text-align: center; }
        #loading { text-align: center; padding: 100px 0; }

        @media (max-width: 768px) { .container { padding: 20px; } .price { font-size: 2rem; } .btn-group { flex-direction: column; } }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo-box">
        <img src="logo.png" class="logo-img">
        <div class="logo-text"><h1>THE NEMI MART</h1></div>
    </a>
</header>

<div id="loading">
    <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--orange);"></i>
    <h2 style="margin-top:20px;">Fetching Purity...</h2>
</div>

<div class="container" id="product-container" style="display:none;">
    <div class="detail-wrapper">
        <div class="product-image" id="img-box"></div>
        <div class="product-info">
            
            <div id="ref-alert">
                <i class="fas fa-gift"></i> <b>Surprise!</b> You got a <b>₹5 Discount</b> because you joined through <span id="referrer-name"></span>'s link!
            </div>

            <div class="category-tag" id="p-cat"></div>
            <h1 id="p-name" style="color:var(--blue); margin:10px 0; font-size: 2rem;"></h1>
            
            <div style="color: var(--green); font-weight: 600;">
                <i class="fas fa-shield-alt"></i> 100% Pure & Organic
            </div>

            <div class="price" id="p-price"></div>
            
            <div class="desc-container">
                <span class="desc-title">Product Description</span>
                <div class="description" id="p-desc"></div>
            </div>
            
            <div class="btn-group">
                <button class="buy-now" id="add-to-cart-btn">
                    <i class="fas fa-shopping-cart"></i> ADD TO CART
                </button>
            </div>

            <div class="share-section">
                <span class="share-title"><i class="fas fa-share-alt"></i> Invite friends & Earn ₹10:</span>
                <div class="share-buttons">
                    <a href="#" class="share-btn wa-share" id="share-wa" title="Share on WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    <a href="#" class="share-btn fb-share" id="share-fb" title="Share on Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="share-btn tw-share" id="share-tw" title="Share on X (Twitter)"><i class="fab fa-x-twitter"></i></a>
                    <button class="share-btn ig-share" onclick="shareInstagram()" title="Share on Instagram"><i class="fab fa-instagram"></i></button>
                    <button class="share-btn copy-share" onclick="copyLink()" title="Copy Link"><i class="fas fa-link"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    <p>© 2026 The Nemi Mart - Purity in Every Purchase</p>
</footer>

<script>
    const _supabase = supabase.createClient("https://rzmftpafcyxburlkwqnm.supabase.co", "sb_publishable_zt4Wt4wBgarEU15zF-RoKw_4achnceD");
    
    // Referral Logic Variables
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    const referrer = urlParams.get('ref'); // Get referrer name from URL

    function fixGDriveLink(link) {
        if (!link) return 'https://via.placeholder.com/500';
        if (link.includes('drive.google.com')) {
            const id = link.split('id=')[1] || link.split('/d/')[1].split('/')[0];
            return `https://lh3.googleusercontent.com/d/${id}`;
        }
        return link;
    }

    async function loadDetails() {
        if(!productId) { window.location.href = 'index.html'; return; }

        const { data, error } = await _supabase.from('products').select('*').eq('id', productId).single();
        if(error || !data) { document.getElementById('loading').innerHTML = "<h1>Product not found!</h1>"; return; }

        // --- Handle Referral Surprise ---
        if (referrer) {
            document.getElementById('ref-alert').style.display = 'block';
            document.getElementById('referrer-name').innerText = referrer;
            // Save referral info for checkout page
            localStorage.setItem('nemi_referral_data', JSON.stringify({
                by: referrer,
                discount: 5
            }));
        }

        // Fill Content
        document.title = `${data.name} | The Nemi Mart`;
        document.getElementById('p-name').innerText = data.name;
        document.getElementById('p-cat').innerText = data.category || 'Pure';
        document.getElementById('p-price').innerText = "₹" + data.price;
        document.getElementById('p-desc').innerText = data.description || "Premium quality product.";
        document.getElementById('img-box').innerHTML = `<img src="${fixGDriveLink(data.image_url)}" alt="${data.name}">`;
        
        // --- Setup Sharing Links with Referral ---
        // Yahan 'Admin' ki jagah user ka naam aana chahiye login system ke baad
        const myName = "Admin"; 
        const pageUrl = window.location.origin + window.location.pathname + `?id=${productId}&ref=${myName}`;
        const shareText = `Check out *${data.name}* at The Nemi Mart! Buy from my link to get ₹5 OFF: `;

        document.getElementById('share-wa').href = `https://wa.me/?text=${encodeURIComponent(shareText + pageUrl)}`;
        document.getElementById('share-fb').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`;
        document.getElementById('share-tw').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(pageUrl)}`;

        // Add to Cart Logic
        document.getElementById('add-to-cart-btn').onclick = () => {
            let cart = JSON.parse(localStorage.getItem('nemi_cart')) || [];
            cart.push({ id: data.id, name: data.name, price: data.price, img: data.image_url });
            localStorage.setItem('nemi_cart', JSON.stringify(cart));
            alert(`${data.name} added to cart!`);
        };

        document.getElementById('loading').style.display = 'none';
        document.getElementById('product-container').style.display = 'block';
    }

    function copyLink() {
        const myName = "Admin";
        const pageUrl = window.location.origin + window.location.pathname + `?id=${productId}&ref=${myName}`;
        navigator.clipboard.writeText(pageUrl).then(() => {
            alert("Referral link copied! Share this to earn rewards.");
        });
    }

    function shareInstagram() {
        copyLink();
        window.location.href = "instagram://";
    }

    loadDetails();
</script>
</body>
</html>
